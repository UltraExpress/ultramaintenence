<!DOCTYPE html>
<html>
<head>
    <title>Photo Upload Test</title>
    <style>
        .item { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .status { margin: 10px 0; color: blue; }
    </style>
</head>
<body>
    <h2>Photo Upload Test</h2>
    <div id="statusMessage" class="status">Ready</div>
    <div id="itemsList"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzL9ffrICvYzdGEnDoj_DV2zoJZQC2wPigydwaG4MZLwAboOwPGBC3BJFsVFn8qt8x0Ww/exec';
        
        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function uploadImage(partId, file) {
            const status = document.getElementById('statusMessage');
            try {
                status.textContent = 'Converting image...';
                const base64Data = await blobToBase64(file);
                
                status.textContent = 'Sending to server...';
                const formData = new FormData();
                formData.append('partId', partId);
                formData.append('photo', base64Data.split(',')[1]);
                formData.append('timestamp', new Date().toISOString());

                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        chunk: JSON.stringify(Object.fromEntries(formData)),
                        index: 0,
                        total: 1,
                        isLast: true
                    })
                });

                status.textContent = 'Upload complete - refreshing...';
                setTimeout(fetchItems, 2000);
            } catch (error) {
                status.textContent = 'Upload Error: ' + error.message;
                console.error('Error:', error);
            }
        }

        function handleImageSelect(partId, input) {
            const file = input.files[0];
            if (file) {
                uploadImage(partId, file);
            }
        }

        async function fetchItems() {
            const status = document.getElementById('statusMessage');
            status.textContent = 'Loading...';
            try {
                const response = await fetch(`${API_URL}?action=getAllData`);
                const result = await response.json();
                
                if (result.status === "success" && Array.isArray(result.data)) {
                    const items = result.data.slice(0, 3);
                    document.getElementById('itemsList').innerHTML = items.map((item, index) => {
                        const partName = item["Part Name"] || '';
                        const partId = item["Part ID"] || '';
                        const photo = item["Complete Photo"] || 'None';
                        
                        return `
                            <div class="item">
                                <strong>${partName}</strong><br>
                                ID: ${partId}<br>
                                Complete Photo: ${photo}<br>
                                <input type="file" 
                                       id="file-${index}"
                                       name="file-${index}"
                                       accept="image/*" 
                                       onchange="handleImageSelect('${partId}', this)">
                            </div>
                        `;
                    }).join('');
                    status.textContent = 'Ready';
                }
            } catch (error) {
                status.textContent = 'Load Error: ' + error.message;
                console.error('Error:', error);
            }
        }

        // Initial load
        fetchItems();
    </script>
</body>
</html>
