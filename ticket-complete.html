const CHUNK_PROPERTY_PREFIX = 'CHUNK_';
const MAX_CHUNK_AGE_MS = 5 * 60 * 1000; // 5 minutes

function doPost(e) {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Max-Age': '86400'
  };

  try {
    const chunkData = JSON.parse(e.postData.contents);
    const { chunk, index, total, isLast } = chunkData;
    
    // Store the chunk
    const scriptProperties = PropertiesService.getScriptProperties();
    const chunkKey = `${CHUNK_PROPERTY_PREFIX}${index}`;
    scriptProperties.setProperty(chunkKey, chunk);
    
    // If this is the last chunk, process the complete data
    if (isLast) {
      // Combine all chunks
      let completeData = '';
      for (let i = 0; i < total; i++) {
        const currentChunk = scriptProperties.getProperty(`${CHUNK_PROPERTY_PREFIX}${i}`);
        if (!currentChunk) {
          throw new Error(`Missing chunk ${i}`);
        }
        completeData += currentChunk;
        
        // Clean up the chunk
        scriptProperties.deleteProperty(`${CHUNK_PROPERTY_PREFIX}${i}`);
      }
      
      // Parse the complete data
      const data = JSON.parse(completeData);
      
      // Get the spreadsheet
      const ss = SpreadsheetApp.openById('1vqHbH2XWmZUR7fEvqAJleDRgVCSPEfynDjDLhVzWybw');
      const sheet = ss.getSheetByName('Sheet1');

      // Find the row with matching partId
      const dataRange = sheet.getDataRange();
      const values = dataRange.getValues();
      const partIdColIndex = 3; // Column D (0-based)
      const completePhotoColIndex = 15; // Column P (0-based)
      const locationColIndex = 1; // Column B (0-based)
      const partNameColIndex = 4; // Column E (0-based)

      let rowIndex = -1;
      for (let i = 0; i < values.length; i++) {
        if (values[i][partIdColIndex] === data.partId) {
          rowIndex = i + 1;
          break;
        }
      }

      if (rowIndex === -1) {
        throw new Error('Part ID not found');
      }

      // Get location and part name for folder structure
      const location = values[rowIndex - 1][locationColIndex];
      const partName = values[rowIndex - 1][partNameColIndex];

      // Create folders structure - same as maintenance app
      const mainFolderName = 'ULTRA Wash Maintenance Files';
      const mainFolder = getOrCreateFolder(mainFolderName);
      const locationFolder = getOrCreateFolder(location, mainFolder);
      const dateFolder = getOrCreateFolder(
        Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd'),
        locationFolder
      );

      // Process the photo
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      let completePhotoUrl = '';

      if (data.completePhoto) {
        const photoBlob = Utilities.newBlob(
          Utilities.base64Decode(data.completePhoto),
          'image/jpeg',
          `${location}_${partName}_complete_${timestamp}.jpg`
        );
        const photoFile = dateFolder.createFile(photoBlob);
        completePhotoUrl = photoFile.getUrl();

        // Update the complete photo URL in column P
        sheet.getRange(rowIndex, completePhotoColIndex + 1).setValue(completePhotoUrl);
      }

      return ContentService.createTextOutput(JSON.stringify({
        status: 'success',
        message: 'Complete photo updated successfully',
        photoUrl: completePhotoUrl
      }))
      .setMimeType(ContentService.MimeType.JSON);
    }
    
    // If not the last chunk, return success
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      message: `Chunk ${index + 1}/${total} received`
    }))
    .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    }))
    .setMimeType(ContentService.MimeType.JSON);
  }
}

// Helper function for creating folders - same as maintenance app
function getOrCreateFolder(folderName, parentFolder = DriveApp) {
  const folderIter = parentFolder.getFoldersByName(folderName);
  
  if (folderIter.hasNext()) {
    return folderIter.next();
  }
  
  return parentFolder.createFolder(folderName);
}

// Setup trigger to clean up old chunks
function cleanupOldChunks() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const allProperties = scriptProperties.getProperties();
  
  for (const key in allProperties) {
    if (key.startsWith(CHUNK_PROPERTY_PREFIX)) {
      scriptProperties.deleteProperty(key);
    }
  }
}
