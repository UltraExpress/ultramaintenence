<!DOCTYPE html>
<html>
<head>
    <title>Script Test</title>
    <style>
        body { max-width: 600px; margin: 20px auto; padding: 20px; }
        select, button, input { display: block; width: 100%; padding: 10px; margin: 10px 0; }
        #preview { max-width: 100%; display: none; margin: 10px 0; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h2>Test Functions</h2>
    
    <button onclick="loadTickets()">1. Load Tickets</button>
    <select id="ticketSelect"><option>Select ticket...</option></select>
    
    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none">
    <button onclick="document.getElementById('photoInput').click()">2. Take Photo</button>
    <img id="preview">
    
    <input type="text" id="notes" placeholder="3. Enter notes">
    
    <button onclick="submitUpdate()">4. Submit Update</button>
    
    <pre id="log">Logs will appear here...</pre>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx2DhThuin2M6_TfL7thQ6X5GWgKn2v5084pbcvs7JGdbAdAxq_SjSK87Z52e3LUPjRHQ/exec';
        let photoData = null;
        
        async function loadTickets() {
            log('Loading tickets...');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getTickets`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const select = document.getElementById('ticketSelect');
                    select.innerHTML = data.data.map(ticket => 
                        `<option value="${ticket.partId}">${ticket.partName} - ${ticket.status}</option>`
                    ).join('');
                    log('Tickets loaded successfully');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                log('Error loading tickets: ' + error);
            }
        }
        
        document.getElementById('photoInput').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoData = e.target.result;
                    document.getElementById('preview').src = photoData;
                    document.getElementById('preview').style.display = 'block';
                    log('Photo loaded');
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        
        async function submitUpdate() {
            const partId = document.getElementById('ticketSelect').value;
            const notes = document.getElementById('notes').value;
            
            if (!partId || !photoData || !notes) {
                log('Please select ticket, take photo, and enter notes');
                return;
            }
            
            log('Submitting update...');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        partId: partId,
                        notes: notes,
                        photo: photoData.split(',')[1]
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    log('Update successful');
                    document.getElementById('preview').style.display = 'none';
                    document.getElementById('notes').value = '';
                    photoData = null;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                log('Error submitting update: ' + error);
            }
        }
        
        function log(message) {
            const logElement = document.getElementById('log');
            logElement.textContent = new Date().toLocaleTimeString() + ': ' + message + '\n' + logElement.textContent;
        }
        
        // Load tickets on startup
        loadTickets();
    </script>
</body>
</html>
